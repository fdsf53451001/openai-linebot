<script>
    // script for rich display modal

    function on_modal_click(entry_field_input){
        $('#ModalRichDisplay').modal('toggle');
        entry_field = entry_field_input;
    }

    function toggle_reply_mode(mode){
        // hide all element in class reply_content
        var reply_content = document.getElementsByClassName("reply_content");
        for (let i = 0; i < reply_content.length; i++) {
            reply_content[i].style.display = "none";
        }
        // display the element with id mode+'_reply_content'
        document.getElementById(mode+'_reply_content').style.display = "block";
    }
    // show default content for image reply
    toggle_reply_mode('image')

    $(document).ready(function() {
        $('#file-input').change(function() {
            var file = this.files[0];
            var fileType = file.type;
            var fileSize = file.size;
            if (fileType != 'image/png' && fileType != 'image/jpeg') {
                alert('只能上傳 PNG 或 JPEG 格式的圖片！');
                return false;
            }
            if (fileSize > 1024 * 1024) {
                alert('圖片大小不能超過 1MB！');
                return false;
            }

            $('#img-upload-status').html('請點擊上傳。')

            var reader = new FileReader();
            reader.onload = function(event) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    // canvas.width = img.width;
                    // canvas.height = img.height;
                    canvas.width = 720;
                    canvas.height = 480;
                    var ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    $('#preview').attr('src', canvas.toDataURL());
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
        $('#upload-form').submit(function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            $.ajax({
                url: "/api/image/img"+"?sid={{PASS_DATA['SID']}}",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    $('#img-upload-status').html('上傳成功！')
                    $('#'+entry_field).val("[LoadImage-" + data + "] ")
                },
                error: function(data) {
                    $('#img-upload-status').html('上傳失敗！')
                    console.error(data)
                }
            });
        });
    });
</script>